%%%==============================================================================
%% Copyright 2022-23 by Alceu Frigeri
%%
%% This work may be distributed and/or modified under the conditions of
%%
%% * The [LaTeX Project Public License](http://www.latex-project.org/lppl.txt),
%%   version 1.3c (or later), and/or
%% * The [GNU Affero General Public License](https://www.gnu.org/licenses/agpl-3.0.html),
%%   version 3 (or later)
%%
%% This work has the LPPL maintenance status *maintained*.
%%
%% The Current Maintainer of this work is Alceu Frigeri
%%
%% This is version 1.12 (2023/09/23)
%%
%% The list of files that compose this work can be found in the README.md file at
%% https://ctan.org/pkg/ufrgscca
%%
%%%==============================================================================
%% UFRGS stands for "Federal University of Rio Grande do Sul" in south Brazil
%% EE    stands for "Engineering School"
%% CCA   stands for "Control and Automation Engineering Course" (Portuguese acronym)
%%%==============================================================================
\NeedsTeXFormat{LaTeX2e}[2022/06/01]


\ProvidesExplPackage
    {ufrgscca-coord}
    {2023/11/10}
    {1.99}
    {UFRGS/CCA coord commands}

\cs_generate_variant:Nn \tl_set:Nn {Ne}

\keys_define:nn { ufrgscca.coord }
  {
    calendar-I. bool_set:N   = \l__ufrgscca_calendarI_bool ,
    calendar-I. usage:n       = general , 
    calendar-II. bool_set:N  = \l__ufrgscca_calendarII_bool ,
    calendar-II. usage:n      = general , 
    report-I. bool_set:N     = \l__ufrgscca_reportI_bool ,
    report-I. usage:n         = general , 
    report-II. bool_set:N    = \l__ufrgscca_reportII_bool ,
    report-II. usage:n        = general , 
    boards. bool_set:N       = \l__ufrgscca_boards_bool ,
    boards. usage:n           = general , 
    revforms-I. bool_set:N   = \l__ufrgscca_revformsI_bool ,
    revforms-I. usage:n       = general , 
    revforms-II. bool_set:N  = \l__ufrgscca_revformsII_bool ,
    revforms-II. usage:n      = general , 
    referral-I. bool_set:N   = \l__ufrgscca_referralI_bool ,
    referral-I. usage:n       = general , 
    referral-II. bool_set:N  = \l__ufrgscca_referralII_bool ,
    referral-II. usage:n      = general , 
    cocertificate. bool_set:N  = \l__ufrgscca_cocertificate_bool ,
    cocertificate. usage:n      = general , 
  }

\ProcessKeyOptions[ufrgscca.coord]\relax
%\NewDocumentCommand{\setreports}{m}{\SetKeys[ufrgscca-coord]{#1}}
\NewDocumentCommand{\setreports}{m}{\keys_set:nn { ufrgscca.coord }{#1}}

\def\c@one#1:#2:{\csname #1\endcsname}
\def\c@two#1:#2:{\csname #1\endcsname[newpage]}
\def\tccoord@split#1:#2:#3#4#5,{#4#1:#2:}
\NewDocumentCommand{\tccoord@student@exec}{m}{\tccoord@split#1::\c@two\c@one\empty,}

\RequirePackage{longtable}
\RequirePackage{multirow}
%\RequirePackage{ufrgscca-gen}
\RequirePackage{ufrgscca-core}
\RequirePackage{ufrgscca-forms}
\RequirePackage{pgfcalendar}

%
%
\NewDocumentCommand{\studentFate}{O{}}{%%
  \str_case:nnF  {#1}
    {
      {C}
        {
          \starray_gset_from_keyval:nn {student} 
            {
              grade = C ,
              flag-exam = \c_true_bool ,
              flag-graded = \c_true_bool ,
              flag-approved = \c_true_bool ,
            }
        }
      {D}
        {
          \starray_gset_from_keyval:nn {student} 
            {
              grade = D ,
              flag-exam = \c_true_bool ,
              flag-graded = \c_true_bool ,
            }
        }
      {FF}
        {
          \starray_gset_from_keyval:nn {student} 
            {
              grade = FF ,
              flag-ff = \c_true_bool ,
              flag-graded = \c_true_bool ,
            }
        }
      {dismiss}
        {
          \starray_gset_from_keyval:nn {student} 
            {
              flag-dismiss = \c_true_bool ,
              flag-graded = \c_true_bool ,
            }
        }
      {none}
        {
          \starray_gset_from_keyval:nn {student} 
            {
              flag-dismiss = \c_true_bool ,
              flag-graded = \c_true_bool ,
            }
        }
    }
    { %% in case of none of above...
      \__ufrgscca_studentgrade:
    }
}%%
%
\tl_new:N \l__ufrgscca_tmpa_tl
\tl_new:N \l__ufrgscca_tmpb_tl
\tl_new:N \l__ufrgscca_tmpc_tl
\tl_new:N \l__ufrgscca_tmpd_tl
\cs_new_protected:Npn \__ufrgscca_studentgrade: 
    {
      %(\DataFields{student}{name})\par
      \starray_term_syntax:n {student.reviewer[1]}
      \tl_set:Ne \l__ufrgscca_tmpa_tl {\starray_parsed_get_prop:n {grade}}
      \starray_term_syntax:n {student.reviewer[2]}
      \tl_set:Ne \l__ufrgscca_tmpb_tl {\starray_parsed_get_prop:n {grade}}
      \starray_term_syntax:n {student.reviewer[3]}
      \tl_set:Ne \l__ufrgscca_tmpc_tl {\starray_parsed_get_prop:n {grade}}
      \int_case:nn {\starray_parsed_get_prop:n {gradetype}}
        {
          {1}
            {
              \tl_set:Ne \l__ufrgscca_tmpd_tl
                {\fpeval{round(((\l__ufrgscca_tmpb_tl + \l__ufrgscca_tmpc_tl)/2),2,1)}}
            }
          {2}
            {
              \tl_set:Ne \l__ufrgscca_tmpd_tl
                {\fpeval{round(((\l__ufrgscca_tmpa_tl + \l__ufrgscca_tmpb_tl + \l__ufrgscca_tmpc_tl)/3),2,1)}}
            }
        }
      \starray_gset_prop:nne {student}{gradeavrg}{\l__ufrgscca_tmpd_tl}
      \fp_compare:nNnTF {\l__ufrgscca_tmpd_tl} < {\UseConst{NgradeC}}
        { % D
          \starray_gset_prop:nnn {student}{grade}{D}
        }
        {
          \fp_compare:nNnTF {\l__ufrgscca_tmpd_tl} < {\UseConst{NgradeB}}
            { % C
              \starray_gset_prop:nnn {student}{grade}{C}
              \starray_gset_prop:nnn {student}{flag-approved}{\c_true_bool}
            }
            {
              \fp_compare:nNnTF {\l__ufrgscca_tmpd_tl} < {\UseConst{NgradeA}}
                { % B
                  \starray_gset_prop:nnn {student}{grade}{B}
                  \starray_gset_prop:nnn {student}{flag-approved}{\c_true_bool}
                }
                { % A
                  \starray_gset_prop:nnn {student}{grade}{A}
                  \starray_gset_prop:nnn {student}{flag-approved}{\c_true_bool}
                }
            }
        }

        \starray_gset_prop:nnn {student}{flag-graded}{\c_true_bool}
    }
%
\NewDocumentCommand{\studenttimeslot}{O{}mm}{%%
  \starray_gset_from_keyval:nn {student}
    {
      board-local = #1 ,
      board-date = #2 ,
      board-time = #3 ,
    }
}%
\let\timeslot\studenttimeslot%
%
\NewDocumentCommand{\tccdate}{mm}{%%
  \SetConsts{%
    date:#1 = #2 ,
  }
}%
%
\NewDocumentCommand{\tccsemester}{m}{%%
  \SetConsts{%
    semester = #1 ,
  }
}%
%


\NewDocumentCommand{\studentturnindate}{m}{\tccoord@studentdatesplit#1,}
%23/12/2022

\def\tccoord@studentdatesplit#1/#2/#3,{
   \pgfcalendarifdate{#3-#2-#1}{at least=\tc@internshipcommitB+1}{\tccoord@studentFF}{}
   \pgfcalendarifdate{#3-#2-#1}{between=\tc@internshipcommitA+1 and \tc@internshipcommitB}{\tccoord@studentExam{X}}{}
   \expandafter\gdef\csname tc@student\Alph{tc@studentcount}date\endcsname{#1/#2/#3}%
}

\NewDocumentCommand{\intershipcommitdates}{mm}{%
    \tccoord@commitdatesplit#1,A,%
    \tccoord@commitdatesplit#2,B,%
}

\def\tccoord@commitdatesplit#1/#2/#3,#4,{
   \expandafter\xdef\csname tc@internshipcommit#4\endcsname{#3-#2-#1}%
   \expandafter\xdef\csname tc@internshipcommit#4#4\endcsname{#1/#2/#3}%
}

%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% ufrgscca-coord !?!!
%%%%%%%%%%%%%%%%
%%%%\NewDocumentCommand{\studentworktitle}{m}{%%
%%%%  \starray_gset_prop:nnn {student}{worktitle}{#1}
%%%%}%
%%%%\let\TCCtitle\studentworktitle%
%%%%%
%%%%%%%%%
%%%%%%%%% ufrgscca-coord !!!
%%%%%%%%%
\NewDocumentCommand{\studentremark}{m}{%%
  \starray_gset_prop:nnn {student}{remarks}{#1}
}%
%
\NewDocumentCommand{\studentsetDistinctBoard}{}{%%
  \starray_gset_prop:nnn {student}{flag-distinctboard}{\c_true_bool}
}%

\NewDocumentCommand{\studentDistinctBoardCase}{mm}
  {
    \starray_term_syntax:n{student}
    \bool_if:nTF {\starray_parsed_get_prop:n{flag-distinctboard}}
      {#1}
      {#2}
  }

\NewDocumentCommand{\studentsetnewpage}{O{}}{%%
  \tl_if_blank:nTF {#1}
    {\starray_set_iter_from_hash:nn {student}{#1}}
  \starray_gset_prop:nnn {student}{flag-newpage}{\c_true_bool}
}%


  %%%
  %%% TO BE ADAPTED for starray !
  %%% TO BE DONE !
%
\NewDocumentCommand{\tccoord@checklist}{m}{\expandafter\gdef\csname tc@student\Alph{tc@studentcount}:#1\endcsname{}}%
\NewDocumentCommand{\checklist}{m}{\forcsvlist{\tccoord@checklist}{#1}}%
%
\NewDocumentCommand{\addtostudent}{mm}{\@ifundefined{#1}{}{\csappto{#1.hook}{#2}}}
%
\NewDocumentCommand{\checkedbox}{}{\ooalign{$\square$\cr\hidewidth\raise.3ex\hbox{$\checkmark\mkern-7mu$}\hidewidth\cr}}%
\NewDocumentCommand{\uncheckedbox}{}{$\square$}%
\NewDocumentCommand{\tccoord@@check}{mm}{\@ifundefined{tc@student#1:#2}{\uncheckedbox}{\checkedbox}}%
\NewDocumentCommand{\tccoord@check}{mm}{\@ifundefined{#2}{}{\tccoord@@check{#1}{\csname #2\endcsname} \csname @\csname #2\endcsname\endcsname}}%
\NewDocumentCommand{\checkdef}{mmm}{\expandafter\gdef\csname #1\endcsname{#2}\expandafter\gdef\csname @#2\endcsname{#3}}%
%\chekmark%


%
\cs_generate_variant:Nn \starray_gset_prop:nnn {nne}
%
\NewDocumentCommand{\examinergrades}{mmmO{}}{%%
  \tl_if_blank:nTF {#1}
    { \starray_gset_prop:nnn {student.reviewer}{grade}{0} }
    {
      \tl_if_blank:nTF {#4}
        { %% 3 grades, TCC II
            \starray_gset_from_keyval:nn {student.reviewer}
              {
                pointA = #1 ,
                pointB = #2 ,
                pointC = #3 ,
                gradetype = 2 ,
              }
            \starray_gset_prop:nne {student.reviewer}{grade}
                {%
                    \fpeval{round((#1 * \UseConst{TCC-II.weightA} + #2 * \UseConst{TCC-II.weightB} + #3 * \UseConst{TCC-II.weightC}) / ( \UseConst{TCC-II.weightA} + \UseConst{TCC-II.weightB} + \UseConst{TCC-II.weightC}) , 2 , 1) }
                }
        }
        { %% 4 grades, TCC I
            \starray_gset_from_keyval:nn {student.reviewer}
              {
                pointA = #1 ,
                pointB = #2 ,
                pointC = #3 ,
                pointD = #4 ,
                gradetype = 1 ,
              }
            \starray_gset_prop:nne {student.reviewer}{grade}
                {%
                    \fpeval{round((#1 * \UseConst{TCC-I.weightA} + #2 * \UseConst{TCC-I.weightB} + #3 * \UseConst{TCC-I.weightC} + #4 * \UseConst{TCC-I.weightD}) / ( \UseConst{TCC-I.weightA} + \UseConst{TCC-I.weightB} + \UseConst{TCC-I.weightC} + \UseConst{TCC-I.weightD}) , 2 , 1) }
                }
    
        }
    }
  
}%


\NewDocumentCommand{\setstudentlist}{mm}{%
  \seq_new:c {l__ufrgscca_#1_seq}
  \seq_new:c {l__ufrgscca_#1_ff_seq}
  \seq_new:c {l__ufrgscca_#1_dismiss_seq}
  \seq_new:c {l__ufrgscca_#1_graded_seq}
  
    \seq_gset_from_clist:cn {l__ufrgscca_#1_seq}{#2}
    \seq_map_tokens:cn {l__ufrgscca_#1_seq} {\__ufrgscca_grade:n}
    \seq_map_tokens:cn {l__ufrgscca_#1_seq} {\__ufrgscca_listclassify:nn {#1}}
}

\cs_new_protected:Npn \__ufrgscca_grade:n #1 
    {
      \starray_set_iter_from_hash:nn {student}{#1}
      \starray_term_syntax:n {student[#1]}
      \bool_if:nF {\starray_parsed_get_prop:n {flag-graded}}
        { \__ufrgscca_studentgrade: }        
    }


\cs_new_protected:Npn \__ufrgscca_listclassify:nn #1#2
    {
      \starray_set_iter_from_hash:nn {student}{#2}
      \starray_term_syntax:n {student}
      \bool_case:nF
        {
          {\starray_parsed_get_prop:n {flag-ff}}{\seq_gput_right:cn {l__ufrgscca_#1_ff_seq}{#2}}
          {\starray_parsed_get_prop:n {flag-dismiss}}{\seq_gput_right:cn {l__ufrgscca_#1_dismiss_seq}{#2}}
        }
        {\seq_gput_right:cn {l__ufrgscca_#1_graded_seq}{#2}}
      
    }

\NewDocumentCommand{\tcgrades}{m}{%
    \seq_map_tokens:cn {l__ufrgscca_#1_seq} {\__ufrgscca_grade:n}
}



\NewDocumentCommand{\tcreports}{O{}m}{
  {
      \setreports{#1}
      \seq_gset_eq:Nc \l__ufrgscca_baselist_seq {l__ufrgscca_#2_seq}
      \seq_gset_eq:Nc \l__ufrgscca_baselist_ff_seq {l__ufrgscca_#2_ff_seq}
      \seq_gset_eq:Nc \l__ufrgscca_baselist_dismiss_seq {l__ufrgscca_#2_dismiss_seq}
      \seq_gset_eq:Nc \l__ufrgscca_baselist_graded_seq {l__ufrgscca_#2_graded_seq}
    
      \bool_if:NT \l__ufrgscca_calendarI_bool
        { \MakeForm{calendar-I} }
      \bool_if:NT \l__ufrgscca_calendarII_bool
        { \MakeForm{calendar-II} }
      \bool_if:NT \l__ufrgscca_reportI_bool
        { \MakeForm{report-I} }
      \bool_if:NT \l__ufrgscca_reportII_bool
        { \MakeForm{report-II} }
      \bool_if:NT \l__ufrgscca_boards_bool
        { \MakeForm{boards} }      
      \seq_map_inline:cn {l__ufrgscca_baselist_seq} 
        {
          \studentSelect{##1}
          \bool_if:NT \l__ufrgscca_cocertificate_bool
            {
              \studentCoadvCase
                {\MakeForm{cocertificate}}
                {}
            }
          \bool_if:NT \l__ufrgscca_referralI_bool
            {
              \studentDismissCase
                {}
                { \MakeForm{referral-I} }
            }
          \bool_if:NT \l__ufrgscca_revformsI_bool
            {
              \SetReviewer{2}
              \MakeForm{examinersform-I}
              \SetReviewer{3}
              \MakeForm{examinersform-I}
              \MakeForm{rectifyapproval-I}
            }
          \bool_if:NT \l__ufrgscca_referralII_bool
            {
              \MakeForm{referral-II}
            }
          \bool_if:NT \l__ufrgscca_revformsII_bool
            {
              \SetReviewer{1}
              \MakeForm{examinersform-II}
              \MakeForm{correctionsform-II}
              \SetReviewer{2}
              \MakeForm{examinersform-II}
              \MakeForm{correctionsform-II}
              \SetReviewer{3}
              \MakeForm{examinersform-II}
              \MakeForm{correctionsform-II}
              \MakeForm{rectifyapproval-II}
            }
        }
  }
}%%


%%% TO BE ADAPTED TO starray

%\NewDocumentCommand{\internshipreports}{O{}m}{%%
%    \setreports{#1}
%    \@ifundefined{tcdef@coord@list#2}{}{%
%        \expandafter\expandafter\expandafter\forcsvlist\expandafter\expandafter\expandafter\tccoord@student@exec\expandafter\expandafter\expandafter{\csname tcdef@coord@list#2\endcsname}
%    }
%    \iftcif@coord@checklist%
%    \tccoord@TCCchecklist%
%    \fi%
%    \iftcif@coord@report%
%    \tccoord@TCCreport%
%    \fi%
%}%%

